\documentclass[a4paper,10pt,oneside]{article}
\usepackage{graphicx}
\usepackage{color}
\usepackage{url}
\usepackage{subfigure}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{tgpagella}
%\usepackage[scale=0.9]{tgcursor}
%\usepackage[scale=0.9]{tgheros}
\usepackage{xstring}

\newcommand{\myscale}{0.74}
\newcommand{\vect}[1]{\boldsymbol{#1}}
\newcommand{\code}[1]{\texttt{\StrSubstitute{#1}{.}{.\.}}}
\def\.{\discretionary{}{}{}}
\newcommand{\jmodule}[1]{\texttt{\textit{#1}}}

\setlength{\hoffset}{-1in} %left margin will be 0, as hoffset is by default 1inch
\setlength{\voffset}{-1in} %analogous voffset
\setlength{\oddsidemargin}{1.5cm}
\setlength{\evensidemargin}{1.5cm}
\setlength{\topmargin}{1.5cm}
\setlength{\textheight}{24cm}
\setlength{\textwidth}{18cm}

\def\mftitle{jInfer ProjectType Module Description}
\def\mfauthor{Michal Klempa, Mário Mikula, Robert Smetana, Michal Švirec, Matej Vitásek}
\def\mfadvisor{RNDr. Irena Mlýnková, Ph.D., Martin Nečaský, Ph.D.}
\def\mfplacedate{Praha, 2011}
\title{\bf\mftitle}
\author{\mfauthor \\ Advisors: \mfadvisor}
\date{\mfplacedate}

\ifx\pdfoutput\undefined\relax\else\pdfinfo{ /Title (\mftitle) /Author (\mfauthor) /Creator (PDFLaTeX) } \fi

\begin{document}
\maketitle
\noindent Target audience: developers willing to extend jInfer, specifically extend jInfer project structure.

\noindent \begin{tabular}{|l|l|} \hline
Responsible developer: & Michal Švirec \\ \hline
Required tokens:       & cz.cuni.mff.ksi.jinfer.base.interfaces.inference.IGGenerator \\
 & cz.cuni.mff.ksi.jinfer.base.interfaces.inference.SchemaGenerator \\
 & cz.cuni.mff.ksi.jinfer.base.interfaces.inference.Simplifier \\
 & org.openide.windows.IOProvider \\ \hline
Provided tokens:       & none \\ \hline
Module dependencies:   & Base \\
	& Runner \\ \hline
Public packages:       & cz.cuni.mff.ksi.jinfer.projecttype.actions \\ \hline
\end{tabular}

\section{Introduction}

\jmodule{ProjectType} is the module representing a jInfer project in the NB platform, which groups input/output files that belongs to one specific inference. Each jInfer project also allows user to set properties specific for inference.\\

\begin{figure}
	\subfigure[Legend: Rectangle is folder, Rounded rectangle is file] {
		\centering\includegraphics[scale=\myscale]{project_dir_structure}
	}
	\caption{Project directory structure} \label{dir-structure}
\end{figure}

With each project created in jInfer is also created specific directory structure on file-system that describes jInfer project. This structure is described in figure \ref{dir-structure}. Folder in file-system is considered as jInfer project folder, if contains \emph{jinferproject} sub-folder. This folder contains two files, first is \emph{project.properties}, where all properties set for particular project are saved. Second file is \emph{input.files} which is XML file filled with paths to files inserted as input into particular project (structure of this file is described in section \ref{input.files}). \emph{Output} sub-folder contains schema files which were generated by jInfer inference.

\section{Structure}
PropertiesPanelProvider
Structure of \jmodule{ProjectType} can be divided into following five main parts.
\begin{itemize}
	\item Base classes - Classes providing main functionality like creation of project, defining operations like move, delete, copy etc. All the base classes are contained in the \code{cz.cuni.mff.ksi.jinfer.projecttype} package.
	\item Visualization classes - These classes create tree structure of project in NBP Projects view and are contained in the \code{cz.cuni.mff.ksi.jinfer.projecttype.nodes}.
	\item Actions - Classes from \code{cz.cuni.mff.ksi.jinfer.projecttype.actions} package that provides actions allowing adding, removing input files into project, or running the project.
	\item Properties - Classes responsible for creation of project properties window with properties category tree. These are situated in  \code{cz.cuni.mff.ksi.jinfer.projecttype.properties} package.
	\item Project wizard - Classes representing creation of project through new project wizard from  \code{cz.cuni.mff.ksi.jinfer.projecttype.sample} package.
\end{itemize}

\subsection{Base classes}


This section describes classes needed for creation of the jInfer project and correct integration into NBP. Main two classes representing jInfer project type are \code{JInferProjectFactory} and \code{JInferProject}.

\subsubsection{JInferProjectFactory}

\code{JInferProjectFactory} is a factory class implementing \code{ProjectFactory} interface provided by NBP. This class is responsible for loading/saving of jInfer project from/to file-system and also determining if folder in file-system is type of jInfer project (contains \emph{jinferproject} sub-folder). For this purpose, class has three methods: \code{isProject()}, \code{save()} and \code{load()}. When jInfer project is loaded from file-system, \code{JInferProjectFactory} creates new instance of \code{JInferProject} passing path to project folder as a constructor parameter. When \code{save()} method is invoked, all the project properties are saved in \emph{projectproperties} file and paths to input files are saved in \emph{input.files}.

\subsubsection{JInferProject}

\code{JinferProject} class implements \code{Project} interface from NBP and represents in-memory representation of jInfer project. Inner structure of this class is very simple, interface provides only two methods: \code{getProjectDirectory()} and \code{getLookup()}. All the extensibility of project type is done by \emph{Lookup} functionality of NBP. Project lookup contains besides properties and \code{Input} class, which encapsulates input files, also class that creates output files, class that builds project tree in project window, etc.

\subsubsection{InputFiles class}\label{input.files}

\code{InputFiles} is utility class that stores/loads input file paths into/from input.files XML file. For this purpose, class uses \emph{JAXB} \cite{JAXB} architecture to unmarshall/marshall XML file into/from java content objects. XML structure of the input.files is very simple, \emph{jinferinput} is root element under which are \emph{documents}, \emph{schemas} and \emph{queries} elements. Each of this elements could have none or more \emph{file} elements with string attribute \emph{loc} that contains absolute path to input file.\\

\noindent Example of the structure follows.
\begin{verbatim}
	<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
	<jinferinput>
	    <xml>
	        <file loc="/home/user/example.xml"/>
	        <file loc="/home/user/example2.xml"/>
	    </xml>
	    <schemas>
	        <file loc="/home/user/example.dtd"/>
	    </schemas>
	    </queries/>
	</jinferinput>
\end{verbatim}

\subsection{Visualization classes}

\begin{figure}
	\centering\includegraphics[scale=\myscale]{node_structure}
	\caption{Project directory structure} \label{node-structure}
\end{figure}

Each jInfer project type in NBP is after creation opened in project window and has some visual tree structure where each node in this tree is represented by NBP \code{Node} class. This structure is in jInfer project type provided by \code{JInferLogicalView} class that implements \code{LogicalViewProvider} interface from NBP and is available through \code{JInferProject} lookup. This class has one important method, \code{createLogicalView()} that returns instance of \code{RootNode} class of root node. Simple class structure is described in figure \ref{node-structure}.\\

\code{RootNode} extends NBP \code{AbstractNode} class which is basic implementation of NBP \code{Node}. This node contains four children nodes: three for input files (Document, Schema and Query) and one for output files generated by inference (Output). Root node also offers actions for adding input files, run inference and standard project actions like delete or move/rename project.\\

Each of the \emph{input} nodes is represented by \code{FolderNode} class and contains \emph{input file} nodes (represented by \code{FileNode} class) representing files added to the jInfer project. Notice that these \emph{input file} nodes represents files from file-system and are not copied to project folder structure. Because of this, if you delete this nodes from project tree, files from file-system are not deleted.\\

\code{OutputNode} class represents \emph{Output} node in jInfer project type tree and is slightly different from \emph{input} nodes, because it refers to \emph{output} sub-folder in project file-system hierarchy. In other words, files contained in this folder are shown as sub-nodes in \emph{Output} node in project tree. This sub-nodes are represented by \code{OutputFileNode} class. Unlike \emph{input file} nodes, if you delete \emph{output file} node under the \emph{Output} node, file represented by this node is also deleted from file-system.

\subsection{Actions}

Each node in project tree hierarchy contains set of actions available from its context menu. Besides standard actions for root node or file node, jInfer project type introduce its own actions. These actions could be separated into three groups: actions for \emph{root} node, actions for \emph{input folder} nodes and one action for \emph{input/output file} nodes implemented by \code{ValidateAction} class. All classes implementing some jInfer project action extend standard java \code{javax.swing.AbstractAction} class besides \code{ValidateAction} class which is described in \ref{validate-action}.\\

\subsubsection{Root node actions}

This group contains two actions, first is action that allows adding input files into \emph{input folder} nodes (implemented by \code{FilesAddAction} class). Second one is slightly different, because unlike from the previous action, this one doesn't create new item in \emph{root} node context menu but implements functionality for item that already exists in context menu - Run action.\\

First of the two actions, after it was invoked, open file choose dialog which has set file filter according to available classes that implement \code{Processor} interface registered in jInfer with \code{ServiceProvider}. After selecting files in dialog, these files are inserted into particular \emph{input file} node according to mapping of file extension to folder type gained from \code{Processor} classes.\\

Run action, which is available in root node context menu, is also present in NBP toolbar as a \emph{Run} button and in jInfer Welcome window. This action is implemented in \code{RunAction} class and simply invokes \jmodule{Runner}s \code{run()} method, if no other inference is already running, otherwise information dialog pops up informing about already running inference. This check is done with \code{setActiveProject()} from \code{RunningProject} class.

\subsubsection{Input folder node actions}

To this group of actions belong two actions: action for adding input files into \emph{input folder} node (\code{FileAddAction} class) and action for deleting all input files in \emph{input folder} node (\code{DeleteAllAction} class). \code{FileAddAction} class implements action which opens file choose dialog and selected files are added into particular \emph{file input}node. \code{DeleteAllAction} class simply removes all input files previously added into particular \emph{file input} node.

\subsubsection{ValidateAction class}\label{validate-action}

TODO what kind of validation did we use. How to extend validation.\\

\code{ValidateAction} class implements action, which allows documents and schema files to be validated against each other. Because of this, action is presented in context menu of document and schema files (in actual implementation is available for XML, dtd and XML schema files). Unlike the other action classes, this extends NBP \code{NodeAction} class, which allows to enable/disable action in context menu according to node selection. Action is enabled only if exactly one schema file is selected and one or more XML files. If the selected XML files are valid against selected schema, information dialog is popped up, otherwise error dialog is popped up and in \emph{validate} output window is printed error message describing cause of non-validity XML files against schema.

\subsection{Properties}

Each jInfer project type has associated properties window through which can user change project-wide properties. This window is accessible through \emph{properties} action in context menu of project \emph{root} node. Properties window consists of category tree on a left side and properties pane on a right side. With each category in a tree is associated one properties pane. Structure of the category tree consists of two type of categories: actual category provided by some module and \emph{virtual} category. Actual category has associated properties pane, which is displayed in a right side of the properties window. \emph{Virtual} category displays as a properties pane special information panel that provides information about count and name of modules which are children of this virtual category. Each actual category could have virtual categories as a children or another actual categories, but not both at a same time. On the other side \emph{virtual} category can have only actual categories as a children. If a \emph{virtual} category has no child, this category is not displayed in a category tree.\\

Category in a properties window is represented by NB platform \code{ProjectCustomizer.Category} class and properties pane is represented by \code{JPanel} class. Classes responsible for creation of this properties window are\\ \code{JInferCustomizerProvider} and \code{JInferComponentProvider}. From Jinfer module point of view is properties category represented by \code{PropertiesPanelProvider} interface and associated properties pane by \code{AbstractPropertiesPanel} abstract class. How to use this interface and abstract class to create custom project properties category presented in jInfer project type properties windowis described in section \ref{properties_reg}.\\


\code{JInferComponentProvider} is very simple class that extends \code{ProjectCustomizer.CategoryComponentProvider} class from NBP and its only method is \code{create()} which takes category as a parameter and returns properties pane. In the \code{JInferCustomizerProvider} class, which extends NBP \code{CustomizerProvider} class, is the core functionality of collecting categories (\code{PropertiesPanelProvider} interface) with associated properties panes (\code{AbstractPropertiesPanel} class) from all jInfer modules.\\

\subsubsection{Custom project properties category}\label{properties_reg}

As was written before, each jInfer project properties category is represented in jInfer modules by \code{PropertiesPanelProvider} interface. To create new category, this interface must be implemented and implementation must be annotated by the following code.
\begin{verbatim}
	@ServiceProvider(service = PropertiesPanelProvider.class)
\end{verbatim}

\code{PropertiesPanelProvider} interface provides the following methods:
\begin{itemize}
	\item getName() - Gets a programmatic name of category
	\item getDisplayName() - Gets a name of category displayed in properties window.
	\item getPriority() - Gets a priority of category, by which is sorted among other sibling categories in a tree.
	\item getPanel() - Gets \code{AbstractPropertiesPanel} representing the category properties pane.
	\item getSubCategories() - Gets a \code{List} of \code{VirtualCategoryPanel} representing virtual category child.
\end{itemize}

\begin{figure}
	\centering\includegraphics[scale=\myscale]{uml_properties}
	\caption{Project directory structure} \label{uml-properties}
\end{figure}


\subsection{Project wizard}

\subsection{Preferences}


\nocite{*}
\newpage
\bibliographystyle{alpha}
\bibliography{literature}

\end{document}
